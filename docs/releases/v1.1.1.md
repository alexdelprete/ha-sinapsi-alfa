# Release Notes - v1.1.1

**Release Date:** 2025-12-18

## Overview

**Patch release** - Fixes VPN connection timeout issue and adds "Skip MAC Detection" option for faster startup on VPN connections.

## Bug Fixes

### Fixed VPN Connection Timeout (Fixes #180)

The root cause of VPN connection failures has been identified and fixed:

**Problem:** In v1.0.x+, MAC address retrieval happened *inside* the ModbusLink context manager. This operation takes up to 75+ seconds (10 retries with exponential backoff), during which no Modbus traffic flows. VPNs typically close idle TCP connections after 30-60 seconds, causing the Modbus connection to die before data collection could begin.

**Solution:** MAC retrieval now happens *before* opening the Modbus connection, ensuring the connection stays open only during actual data reads (sub-second operations).

### Reduced MAC Retry Attempts

Changed `MAX_RETRY_ATTEMPTS` from 10 to 5 for faster fallback on VPN/high-latency networks:

| Setting | Before | After |
|---------|--------|-------|
| `MAX_RETRY_ATTEMPTS` | 10 | 5 |
| Worst-case MAC retrieval time | ~75s | ~31s |

## New Features

### Skip MAC Detection Option

Added a new configuration option for VPN users to bypass MAC address retrieval entirely:

| Parameter | Default | Description |
|-----------|---------|-------------|
| `skip_mac_detection` | `false` | Skip MAC detection and use host-based ID |

**Why This Matters:**

- **ARP doesn't traverse VPN tunnels** - MAC address retrieval uses ARP, which operates at Layer 2. VPNs operate at Layer 3, so MAC retrieval will always fail over VPN.
- **Eliminates startup delay** - When enabled, the integration starts immediately without waiting for MAC retrieval to fail.
- **Stable entity IDs** - Uses `{host}_{port}` as the device identifier instead of MAC address.

**Configuration:**

1. Go to **Settings → Devices & Services → Alfa by Sinapsi**
2. Click **Configure**
3. Enable **Skip MAC Detection**

**When to Enable:**

| Network Type | Skip MAC Detection |
|--------------|-------------------|
| Local LAN | Disabled (default) |
| VPN connection | **Enabled** (recommended) |
| Remote/WAN | **Enabled** |

## Technical Details

### Root Cause Analysis

**v0.5.0 (pymodbus) - Working:**
```
1. connect() → Connection established
2. get_mac_address() → 75+ seconds (connection already open)
3. read_modbus_alfa() → Success
4. close()
```

**v1.0.x+ (ModbusLink) - Failing:**
```
1. async with client: → Connection opens
2. get_mac_address() → 75+ seconds (connection dies during this)
3. read_modbus_alfa() → FAILS - "Async TCP connection not established"
```

**v1.1.1 (Fixed):**
```
1. get_mac_address() → Before connection (or skipped if option enabled)
2. async with client: → Connection opens
3. read_modbus_alfa() → Success (sub-second)
```

## Files Changed

| File | Changes |
|------|---------|
| `const.py` | Added `CONF_SKIP_MAC_DETECTION`, `DEFAULT_SKIP_MAC_DETECTION`; reduced `MAX_RETRY_ATTEMPTS` to 5 |
| `api.py` | Added `skip_mac_detection` parameter; moved MAC retrieval outside context manager |
| `config_flow.py` | Added "Skip MAC Detection" checkbox to ConfigFlow and OptionsFlow |
| `coordinator.py` | Extract `skip_mac_detection` from config and pass to API |

## Acknowledgments

Thanks to Lorenzo Canale ([@lorenzocanalelc](https://github.com/lorenzocanalelc)) for reporting the VPN connection issue and providing detailed debug logs that helped identify the root cause in [#180](https://github.com/alexdelprete/ha-sinapsi-alfa/issues/180).

## Requirements

- Home Assistant 2025.10.0 or newer
- Python 3.13.2 or newer

## Upgrade Notes

- **VPN users**: Enable "Skip MAC Detection" in the integration options for immediate startup
- **Local network users**: No changes needed; the fix improves reliability for all users
- **Existing entity IDs**: If you enable "Skip MAC Detection", entity IDs will change from MAC-based to host-based on next restart

## Full Changelog

https://github.com/alexdelprete/ha-sinapsi-alfa/compare/v1.1.0...v1.1.1
