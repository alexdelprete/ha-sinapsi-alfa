# Release Notes - v1.1.9

**Release Date:** 2025-12-21

## Overview

**Patch release** - Improves error recovery for Transaction ID mismatch and CRC errors by resetting the connection and retrying.

## Bug Fixes

### Improved Protocol Error Recovery

When Transaction ID mismatch or CRC errors occur, the integration now:

1. **Resets the connection** - Closes and reopens the Modbus transport to clear stale responses
2. **Retries with delay** - Waits 3 seconds before retrying to let late responses clear
3. **Attempts up to 3 times** - Same retry count as other transient errors

Previously, these errors were treated as fatal and caused immediate failure, leaving the connection in a corrupted state that prevented recovery.

**Before:** Integration fails and cannot recover until restart
**After:** Integration resets connection and retries, recovering automatically

## Technical Details

### Root Cause

Transaction ID mismatch errors (`Expected 3627, Received 3626`) occur when:
- A response from a previous request arrives late
- Stale responses remain buffered in the connection
- Subsequent reads receive the wrong response

### Solution

Added `_reset_connection()` method that:
1. Closes the transport to discard buffered data
2. Waits 0.5 seconds for clean state
3. Reopens the transport with fresh connection

Changed error handling for `InvalidResponseError` and `CRCError` from non-retriable to retriable with connection reset.

## Files Changed

| File | Changes |
|------|---------|
| `api.py` | Added `_reset_connection()` method |
| `api.py` | Added `BATCH_RETRY_DELAY_PROTOCOL = 3.0` constant |
| `api.py` | Made `InvalidResponseError` and `CRCError` retriable with connection reset |
| `manifest.json` | Version bump to 1.1.9 |
| `const.py` | Version bump to 1.1.9 |

## Requirements

- Home Assistant 2025.10.0 or newer
- Python 3.13.2 or newer
- ModbusLink 1.3.1 or newer

## Upgrade Notes

- No configuration changes required
- Integration should now recover automatically from protocol errors
- Check logs for "resetting connection" messages to verify recovery is working

## Full Changelog

https://github.com/alexdelprete/ha-sinapsi-alfa/compare/v1.1.8...v1.1.9
