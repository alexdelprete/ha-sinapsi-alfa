# Release Notes - v1.1.9

**Release Date:** TBD

## Overview

**Patch release** - Improves protocol error recovery to reduce recovery time from 2-3 minutes to under 1 minute.

## Bug Fixes

### Improved Protocol Error Recovery

When Transaction ID mismatch or CRC errors occur, recovery is now faster:

1. **Increased reset delay** - Changed from 0.5s to 1.0s to better clear TCP buffers and stale responses
2. **Early abort on cascade** - If 3+ protocol errors occur in a single update cycle, the cycle aborts early instead of continuing to retry all 5 batches

**Before:** A cascade of protocol errors could take 2-3 minutes to recover as each of the 5 batches would burn through its full retry budget.

**After:** Early abort detects the cascade and fails fast, allowing the next scan_interval to start with a clean state.

### Technical Details

- Added `MAX_PROTOCOL_ERRORS_PER_CYCLE = 3` constant
- Added `_protocol_errors_this_cycle` tracking across batch reads
- Added `_check_protocol_error_limit()` helper method for TRY301 compliance
- Protocol errors are logged with running count for debugging

## Files Changed

- **`api.py`** - Increased reset delay from 0.5s to 1.0s
- **`api.py`** - Added protocol error tracking and early abort logic

## Requirements

- Home Assistant 2025.10.0 or newer
- Python 3.13.2 or newer
- ModbusLink 1.3.1 or newer

## Upgrade Notes

- No configuration changes required
- Check logs for "Aborting cycle early due to repeated protocol errors" messages
- This indicates the early abort is working as intended

## Known Limitations

Transaction ID mismatch after timeouts is a fundamental limitation of Modbus TCP that affects all libraries (ModbusLink, pymodbus, libmodbus). The root fix requires upstream library changes:

- Response queue flushing
- Transaction ID resync on mismatch

See ModbusLink Issue #4 for related discussion.

## Full Changelog

https://github.com/alexdelprete/ha-sinapsi-alfa/compare/v1.1.8...v1.1.9
