# Release Notes - v1.1.8

**Release Date:** 2025-12-21

## Overview

**Patch release** - Fixes integration reload and improves protocol error recovery.

## Bug Fixes

### Fixed Integration Reload

The integration now properly reloads without requiring a Home Assistant restart.

**Root Cause:** The `SinapsiAlfaAPI` class was missing a `close()` method that is called during integration unload. This caused an `AttributeError` during the unload process, preventing clean reload.

**Fix:** Added `async def close()` method to properly close the Modbus transport connection during unload.

### Improved Protocol Error Recovery

When Transaction ID mismatch or CRC errors occur, the integration now:

1. **Resets the connection** - Closes and reopens the Modbus transport to clear stale responses
2. **Retries with delay** - Waits 3 seconds before retrying to let late responses clear
3. **Attempts up to 3 times** - Same retry count as other transient errors

Previously, these errors were treated as fatal and caused immediate failure, leaving the connection in a corrupted state that prevented recovery.

**Root Cause:** Transaction ID mismatch errors (`Expected 3627, Received 3626`) occur when a response from a previous request arrives late and stale responses remain buffered in the connection.

**Fix:** Added `_reset_connection()` method that closes the transport to discard buffered data, waits for clean state, and reopens with a fresh connection.

## Files Changed

| File | Changes |
|------|---------|
| `api.py` | Added `close()` method to `SinapsiAlfaAPI` class |
| `api.py` | Added `_reset_connection()` method |
| `api.py` | Added `BATCH_RETRY_DELAY_PROTOCOL = 3.0` constant |
| `api.py` | Made `InvalidResponseError` and `CRCError` retriable with connection reset |
| `manifest.json` | Version bump to 1.1.8 |
| `const.py` | Version bump to 1.1.8 |

## Requirements

- Home Assistant 2025.10.0 or newer
- Python 3.13.2 or newer
- ModbusLink 1.3.1 or newer

## Upgrade Notes

- No configuration changes required
- Integration can now be reloaded from UI without restarting Home Assistant
- Integration should now recover automatically from protocol errors
- Check logs for "resetting connection" messages to verify recovery is working

## Full Changelog

https://github.com/alexdelprete/ha-sinapsi-alfa/compare/v1.1.7...v1.1.8
