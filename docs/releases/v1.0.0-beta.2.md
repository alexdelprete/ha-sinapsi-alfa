# Release Notes - v1.0.0-beta.2

**Release Date**: 2025-12-07
**Type**: Beta Release (Pre-release)
**Status**: Ready for Testing

## Overview

This beta continues the ModbusLink migration with major performance improvements and ModbusLink best practices implementation.

## What's Changed

### üöÄ Performance Improvements

- **Batch register reads** - 5 batches instead of 20 individual reads (~75% reduction in Modbus requests)
- **Parallel batch reads** - Uses `asyncio.gather()` for concurrent batch execution (~4x faster)
- **Removed unnecessary lock** - `self._lock` removed since DataUpdateCoordinator already serializes updates

### ‚ú® Code Improvements

- **Context manager usage** - `async with self._client:` for automatic connection handling
- **Layered error handling** - Retry transient errors (connection, timeout) with backoff, fail fast on protocol errors (CRC, invalid response)
- **Dynamic sensor mapping** - `SENSOR_MAP` built automatically from `SENSOR_ENTITIES` + `REGISTER_BATCHES`
- **Better type annotations** - Fixed Pylance type errors with proper `BaseException` handling and `cast()`

### üìÅ New Code Structure

**Added to `const.py`:**

- `REGISTER_BATCHES` - Batch configuration for grouped register reads

**Added to `api.py`:**

- `_build_sensor_map()` - Builds batch-to-sensor mapping at module load
- `_read_batch()` - Reads batch with retry logic for transient errors
- `_extract_uint16()` / `_extract_uint32()` - Extract values from batch results
- `_extract_sensor_value()` - Extract sensor value using SENSOR_MAP
- `_check_batch_errors()` - Helper to check and re-raise batch exceptions

### üóëÔ∏è Removed Code

- `self._lock` and all lock usage (unnecessary)
- `read_holding_registers()` method (replaced by batch reads)
- `_decode_register_value()` method (replaced by extraction methods)
- `_read_and_process_sensor()` method (replaced by batch processing)
- `connect()` / `close()` methods (replaced by context manager)

### üßπ Code Quality

- Fixed ruff linting issues in `sensor.py` (list comprehension, unnecessary else)
- Fixed ruff linting issue in `config_flow.py` (specific type ignore)
- Fixed Pylance type errors with proper `BaseException` handling

## Performance Summary

| Metric | Before | After |
|--------|--------|-------|
| Modbus requests per cycle | 20 | 5 |
| Estimated latency | ~1000ms | ~250ms |
| Lock overhead | Yes | No |
| Connection handling | Manual | Context manager |

## Testing Focus

- [ ] All 24 sensors read correctly
- [ ] Batch offsets are correct (verify each sensor value)
- [ ] uint32 big-endian decoding correct
- [ ] Parallel batch reads work
- [ ] Context manager cleanup works
- [ ] Error handling works (device offline)
- [ ] Retry logic works (transient errors recover)
- [ ] Performance improvement measurable

## Documentation

- See [v1.0.0-beta.1 release notes](v1.0.0-beta.1.md) for ModbusLink migration details

---

**Full Changelog**: [v1.0.0-beta.1...v1.0.0-beta.2](https://github.com/alexdelprete/ha-sinapsi-alfa/compare/v1.0.0-beta.1...v1.0.0-beta.2)
