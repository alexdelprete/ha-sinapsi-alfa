# Release Notes - v0.5.0-beta.1

‚ö†Ô∏è **This is a BETA release** - Please test thoroughly before using in production!

This beta release aligns **ha-sinapsi-alfa** with critical fixes and improvements from **ha-abb-powerone-pvi-sunspec v4.1.5**.

---

## üî¥ Critical Bug Fixes

### Sensor Availability ‚ö†Ô∏è HIGH PRIORITY
- **Fixed**: Sensors now properly show as "unavailable" when the device is offline or unreachable
- **Impact**: Users will no longer see stale data when the device disconnects
- **Benefit**: Clearer system state visibility in Home Assistant

**The Problem:**
- Before this fix, sensors would display the last known value even when the device was offline
- No indication to users that the data was stale
- Could lead to incorrect automation decisions based on outdated sensor values

**The Solution:**
- Changed `api.py` to raise exceptions instead of returning `False` on connection failures
- `connect()` method now raises `SinapsiConnectionError` when device is unreachable
- `async_get_data()` method now raises exceptions when data read or connection fails
- Coordinator properly handles exceptions and marks entities as unavailable

### Resource Leak Fix ‚ö†Ô∏è HIGH PRIORITY
- **Fixed**: Integration unload now only cleans up resources when platform unload succeeds
- **Impact**: Prevents memory leaks and connection issues during integration reload
- **Benefit**: More stable operation over long periods and multiple reload cycles

### Connection Health Tracking
- **Added**: Connection health monitoring throughout the API lifecycle
- **Impact**: Better error recovery and diagnostics
- **Benefit**: More resilient connection handling and clearer error states

---

## üü° Code Quality Improvements

### Standardized Logging
- Created centralized logging helpers (`log_debug`, `log_info`, `log_warning`, `log_error`)
- Consistent context-based format: `(function_name) [key=value]: message`
- Applied across all modules for better debugging and log analysis

### Enhanced Error Handling
- Added custom exception classes: `SinapsiConnectionError`, `SinapsiModbusError`
- Better error messages with context (host, port, address, operation)
- Improved error tracking in API and coordinator

### Improved Validation
- Added validation constants: `MAX_SCAN_INTERVAL`, `MIN_PORT`, `MAX_PORT`
- Changed from `vol.Range()` to `vol.Clamp()` for better UX in config flow
- Port validation method in API with proper error handling

### Code Modernization
- `async_update_device_registry()` and `async_reload_entry()` now use `@callback` decorator
- Simplified `RuntimeData` dataclass (update_listener auto-managed)
- Proper cleanup pattern in `async_unload_entry()`

---

## üìã Files Modified

- **helpers.py**: Added logging helpers, improved host validation (IPv6 support)
- **const.py**: Added VERSION constant, validation constants, improved STARTUP_MESSAGE
- **api.py**: Connection health tracking, validation methods, standardized logging
- **__init__.py**: Fixed unload issues, proper callbacks, configuration_url in device registry
- **sensor.py**: Added availability property, standardized logging
- **coordinator.py**: MAX_SCAN_INTERVAL enforcement, improved logging
- **config_flow.py**: Better validation, custom exception handling
- **manifest.json**: Version bump to 0.5.0-beta.1

---

## ‚úÖ Preserved Sinapsi-Specific Features

All device-specific features remain unchanged:
- ‚úÖ All Modbus register addresses preserved
- ‚úÖ Italian sensor names unchanged
- ‚úÖ Special value handling intact (INVALID_DISTACCO_VALUE, MAX_EVENT_VALUE)
- ‚úÖ Calculated sensors preserved (potenza_consumata, energia_consumata, etc.)
- ‚úÖ Device constants unchanged (MANUFACTURER="Sinapsi", MODEL="Alfa")

---

## üß™ Testing Recommendations

Before deploying to production, please test:

1. **Integration Reload**: Reload the integration multiple times, verify no errors
2. **Sensor Availability**: Disconnect network/device, verify sensors show "unavailable"
3. **Config Flow**: Try invalid inputs (wrong ports, invalid IPs, extreme scan intervals)
4. **Error Logging**: Check logs have consistent, clear format with context
5. **Network Recovery**: Test recovery from connection failures and timeouts
6. **Options Flow**: Change scan interval and other settings, verify they work

---

## üìù Known Issues

- None currently known - please report any issues you find!

---

## üîÑ Migration Notes

This is a **drop-in replacement** for v0.4.2. No configuration changes required.

Simply:
1. Stop Home Assistant (or disable the integration)
2. Replace the integration files
3. Restart Home Assistant (or re-enable the integration)
4. Monitor logs for any issues

---

## üìö Documentation

For more information about the ABB PowerOne v4.1.5 improvements this is based on:
https://github.com/alexdelprete/ha-abb-powerone-pvi-sunspec/releases/tag/v4.1.5

---

## üôè Acknowledgments

This release incorporates improvements from the [ABB Power-One PVI SunSpec](https://github.com/alexdelprete/ha-abb-powerone-pvi-sunspec) integration v4.1.5, which underwent 6 beta iterations to ensure stability.

---

## üìû Support

If you encounter any issues:
1. Check the Home Assistant logs for detailed error messages
2. Report issues at: https://github.com/alexdelprete/ha-sinapsi-alfa/issues
3. Include log excerpts showing the new standardized log format

---

**Full Changelog**: https://github.com/alexdelprete/ha-sinapsi-alfa/compare/v0.4.2...v0.5.0-beta.1

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)
