# Release Notes - v1.0.0-beta.1

**Release Date**: December 2025
**Type**: Beta Release (Pre-release)
**Status**: Testing Required

## Overview

This is a **major architectural change** that migrates the Modbus communication layer from pymodbus to ModbusLink. This beta release requires extensive testing before stable release.

## Breaking Changes

### Dependency Change

- **Removed**: `pymodbus>=3.11.2`
- **Added**: `modbuslink>=1.2.0`

This is an internal change and should not affect users, but the underlying Modbus library is completely different.

### Removed Files

The following files have been removed as they are no longer needed:

- `pymodbus_constants.py` - Local copy of deprecated pymodbus Endian enum
- `pymodbus_payload.py` - Local copy of deprecated BinaryPayloadDecoder

## What's Changed

### ModbusLink Migration

The integration now uses [ModbusLink](https://github.com/Miraitowa-la/ModbusLink) instead of pymodbus for Modbus TCP communication.

**Key changes in `api.py`:**

1. **New imports**:

   ```python
   from modbuslink import AsyncModbusClient, AsyncTcpTransport
   from modbuslink import ConnectionError as ModbusConnectionError
   from modbuslink import TimeoutError as ModbusTimeoutError
   from modbuslink import ModbusException
   ```

1. **Transport/Client pattern**:

   ```python
   self._transport = AsyncTcpTransport(host, port, timeout)
   self._client = AsyncModbusClient(self._transport)
   ```

1. **Connection management**:

   - `await self._transport.open()` instead of `await self._client.connect()`
   - `await self._transport.close()` instead of `self._client.close()`
   - `self._transport.is_open` instead of `self._client.connected`

1. **Register reading**:

   - Returns `List[int]` directly (no `.registers` attribute)
   - No `isError()` check needed - exceptions raised automatically

1. **Simplified decoding**:

   - Direct register value access
   - Manual big-endian 32-bit decoding: `(registers[0] << 16) | registers[1]`

### Benefits

- **Cleaner codebase**: Removed 663 lines of deprecated pymodbus code
- **Modern async API**: Native asyncio with proper context manager support
- **Better error handling**: Structured exception hierarchy
- **Future-proof**: ModbusLink is actively developed with modern Python patterns

### Risk Acknowledgment

ModbusLink is currently in **Alpha status** (Development Status 3). This migration prioritizes modern API design over production stability guarantees.

## Testing Checklist

Please verify the following during beta testing:

- [ ] All 24 sensors read correctly (20 device + 4 calculated)
- [ ] Power sensors (uint16) decode correctly
- [ ] Energy sensors (uint32) decode correctly with big endian byte order
- [ ] Connection/disconnection cycles work properly
- [ ] Device offline scenarios are handled gracefully
- [ ] Timeout scenarios are handled correctly
- [ ] Integration reload works
- [ ] Integration unload works
- [ ] Long-running stability (24+ hours without issues)
- [ ] No memory leaks observed
- [ ] Error messages are clear and actionable

## Documentation

- See [ModbusLink Migration Analysis](../analysis/modbuslink-migration-analysis.md) for detailed migration documentation
- Updated [CLAUDE.md](../../CLAUDE.md) with ModbusLink information

## Rollback Instructions

If critical issues are encountered:

1. Downgrade to v0.5.0 (last pymodbus version)
1. Report issues at [GitHub Issues](https://github.com/alexdelprete/ha-sinapsi-alfa/issues)

## Feedback

Please report any issues or feedback:

- GitHub Issues: <https://github.com/alexdelprete/ha-sinapsi-alfa/issues>
- Include logs with debug enabled for Modbus-related issues

______________________________________________________________________

**Full Changelog**: [v0.5.0...v1.0.0-beta.1](https://github.com/alexdelprete/ha-sinapsi-alfa/compare/v0.5.0...v1.0.0-beta.1)
