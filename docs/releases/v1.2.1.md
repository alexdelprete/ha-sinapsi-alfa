# v1.2.1

**Release Date:** 2026-01-02

**Type:** Stable Release - Feature Update

## Highlights

This release brings advanced device automation features and configurable repair notifications.

## What's New

### Device Triggers for Home Assistant Automations

Create powerful automations that respond to device connectivity events:

- **device_unreachable** - Triggered when the device cannot be reached (network/connection issues)
- **device_not_responding** - Triggered when Modbus communication fails
- **device_recovered** - Triggered when the device comes back online

To use device triggers:

1. Go to Settings > Automations & Scenes > Create Automation
2. Add a Device trigger
3. Select your Sinapsi Alfa device
4. Choose the trigger type (unreachable, not responding, or recovered)

### Configurable Repair Notifications

New options in the integration's Options flow:

- **Enable repair notifications** - Toggle to enable/disable repair issue creation (default: enabled)
- **Failures threshold** - Number of consecutive failures before creating a repair issue (1-10, default: 3)
- **Recovery script** - Optional script to execute when failures threshold is reached

### Recovery Script Support

Configure a Home Assistant script to run automatically when connection failures reach the threshold.
The script receives these variables:

- `device_name` - Device name
- `host` - IP address/hostname
- `port` - TCP port
- `serial_number` - Device serial number
- `mac_address` - Device MAC address
- `failures_count` - Number of consecutive failures

Example use case: Restart a smart plug that powers the device, or send a notification.

### Recovery Notifications

When a device recovers after a failure period, a new repair notification shows:

- When the failure started
- When the device recovered
- Total downtime duration
- Whether a recovery script was executed (and when)

### Enhanced Options Flow UI

The Options flow now uses modern Home Assistant selectors:

- **EntitySelector** for recovery script selection (filters to script domain)
- **NumberSelector** for numeric values (with min/max validation)

### Config Entry Version 3

Automatic migration from v2 to v3 adds new options with sensible defaults:

- `enable_repair_notification`: true
- `failures_threshold`: 3
- `recovery_script`: "" (empty)

## Breaking Changes

None. Automatic migration handles the config entry upgrade.

## Technical Details

### New Files

- `device_trigger.py` - Home Assistant device automation triggers

### Modified Files

- `const.py` - New constants for repair notification options
- `repairs.py` - Recovery notification function
- `coordinator.py` - Device triggers, recovery script execution, downtime tracking
- `__init__.py` - v2â†’v3 migration, device_id storage
- `config_flow.py` - VERSION=3, new selectors
- `translations/*.json` - All 10 translation files updated

## Upgrade Instructions

1. Update via HACS or download the latest release
2. Restart Home Assistant
3. Your existing configuration will be automatically migrated
4. (Optional) Configure new options in integration settings

## Full Changelog

[Compare v1.2.0...v1.2.1](https://github.com/alexdelprete/ha-sinapsi-alfa/compare/v1.2.0...v1.2.1)
