# Release Notes - v1.0.0-beta.4

**Release Date**: 2025-12-07
**Type**: Beta Release (Pre-release)
**Status**: Ready for Testing

## Overview

This beta fixes Transaction ID mismatch errors caused by parallel batch reads over a single Modbus TCP connection.

## What's Changed

### Bug Fixes

- **Fixed Transaction ID mismatch errors** - Replaced parallel `asyncio.gather()` with sequential batch reads to avoid Modbus TCP protocol violations

## Technical Details

**Root Cause**: `asyncio.gather()` sent all 5 batch reads in parallel over the same TCP connection. Modbus TCP uses transaction IDs to match requests/responses, but concurrent requests caused ID mismatches:

```
事务ID不匹配 | Transaction ID mismatch: 期望 | Expected 5, 收到 | Received 1
```

**Fix**: Batch reads are now executed sequentially. This still provides 75% fewer requests than individual register reads (5 batches vs 20 individual reads).

### Code Changes

- `read_modbus_alfa()` now uses sequential for-loop instead of `asyncio.gather()`
- Removed `_check_batch_errors()` method (no longer needed)
- Removed `cast` import (no longer needed)

## Performance

| Approach                           | Requests per cycle |
| ---------------------------------- | ------------------ |
| Individual reads (v0.5.0)          | 20                 |
| Sequential batches (v1.0.0-beta.4) | 5                  |

Still **75% reduction** in Modbus requests compared to individual reads.

## Testing Focus

- [ ] No Transaction ID mismatch errors
- [ ] All 24 sensors read correctly
- [ ] Device connection stable over time
- [ ] Error recovery works (device offline/online)

## Documentation

- See [v1.0.0-beta.3 release notes](v1.0.0-beta.3.md) for IPv4 connection fix
- See [v1.0.0-beta.2 release notes](v1.0.0-beta.2.md) for batch read implementation
- See [v1.0.0-beta.1 release notes](v1.0.0-beta.1.md) for ModbusLink migration details

______________________________________________________________________

**Full Changelog**: [v1.0.0-beta.3...v1.0.0-beta.4](https://github.com/alexdelprete/ha-sinapsi-alfa/compare/v1.0.0-beta.3...v1.0.0-beta.4)
