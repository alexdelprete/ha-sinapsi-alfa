name: "Release"

on:
  release:
    types:
      - "published"

permissions: {}

jobs:
  release:
    name: "Release"
    runs-on: "ubuntu-latest"
    permissions:
      contents: write
    steps:
      - name: "Checkout the repository"
        uses: "actions/checkout@v6"

      - name: "Validate version numbers"
        shell: "bash"
        run: |
          # Extract version from tag (remove 'v' prefix if present)
          TAG_VERSION="${{ github.event.release.tag_name }}"
          TAG_VERSION="${TAG_VERSION#v}"

          # Extract version from manifest.json
          MANIFEST_VERSION=$(yq -r '.version' "${{ github.workspace }}/custom_components/sinapsi_alfa/manifest.json")

          # Extract VERSION from const.py
          CONST_VERSION=$(grep -E "^VERSION = " "${{ github.workspace }}/custom_components/sinapsi_alfa/const.py" | sed 's/VERSION = "\(.*\)"/\1/')

          echo "Tag version:      $TAG_VERSION"
          echo "manifest.json:    $MANIFEST_VERSION"
          echo "const.py:         $CONST_VERSION"

          # Validate all versions match
          if [[ "$TAG_VERSION" != "$MANIFEST_VERSION" ]] || [[ "$TAG_VERSION" != "$CONST_VERSION" ]]; then
            echo ""
            echo "::error::Version mismatch detected!"
            echo ""
            echo "ERROR: Version mismatch!"
            echo "  Tag:           $TAG_VERSION"
            echo "  manifest.json: $MANIFEST_VERSION"
            echo "  const.py:      $CONST_VERSION"
            echo ""
            echo "Please update versions in manifest.json and const.py before releasing."
            echo "See CLAUDE.md for the release process."
            exit 1
          fi

          echo ""
          echo "âœ“ All versions match: $TAG_VERSION"

      - name: "ZIP the integration directory"
        shell: "bash"
        run: |
          cd "${{ github.workspace }}/custom_components/sinapsi_alfa"
          zip sinapsi_alfa.zip -r ./

      - name: "Upload the ZIP file to the release"
        uses: softprops/action-gh-release@v2.5.0
        with:
          files: ${{ github.workspace }}/custom_components/sinapsi_alfa/sinapsi_alfa.zip
